name: "ğŸš€ Deploy to EC2"

on:
  push:
    branches:
      - "**"

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.meta.outputs.sha }}
    steps:
      - name: "ğŸ§° Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ“Œ Capture commit"
        id: meta
        run: echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

  deploy:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ§° Checkout repository"
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.sha }}

      - name: "ğŸ” Configure SSH access"
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          cat > ~/.ssh/config <<'CFG'
          Host ec2
            HostName ${{ secrets.EC2_HOST }}
            User ${{ secrets.EC2_USER }}
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
          CFG

      - name: "ğŸ§© Generate environment (.env) file"
        run: |
          # OpenAI + MCP
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
          echo "ENDPOINT_MCP=${{ secrets.ENDPOINT_MCP }}" >> .env

          # Langsmith
          echo "LANGCHAIN_API_KEY=${{ secrets.LANGCHAIN_API_KEY }}" >> .env
          echo "LANGCHAIN_ENDPOINT=${{ secrets.LANGCHAIN_ENDPOINT }}" >> .env
          echo "LANGCHAIN_PROJECT=${{ secrets.LANGCHAIN_PROJECT }}" >> .env
          echo "LANGCHAIN_TRACING_V2=${{ secrets.LANGCHAIN_TRACING_V2 }}" >> .env

          # WhatsApp
          echo "WHATSAPP_PHONE_ID=${{ secrets.WHATSAPP_PHONE_ID }}" >> .env
          echo "WHATSAPP_TOKEN=${{ secrets.WHATSAPP_TOKEN }}" >> .env
          echo "WHATSAPP_VERIFY_TOKEN=${{ secrets.WHATSAPP_VERIFY_TOKEN }}" >> .env

          # Telegram
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env

          # Supabase
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env

          # Roomdoo
          echo "ROOMDOO_LOGIN_URL=${{ secrets.ROOMDOO_LOGIN_URL }}" >> .env
          echo "ROOMDOO_USERNAME=${{ secrets.ROOMDOO_USERNAME }}" >> .env
          echo "ROOMDOO_PASSWORD=${{ secrets.ROOMDOO_PASSWORD }}" >> .env
          echo "ROOMDOO_AVAIL_URL=${{ secrets.ROOMDOO_AVAIL_URL }}" >> .env
          echo "ROOMDOO_PMS_PROPERTY_ID=${{ secrets.ROOMDOO_PMS_PROPERTY_ID }}" >> .env
          echo "ROOMDOO_BEARER_TOKEN=${{ secrets.ROOMDOO_BEARER_TOKEN }}" >> .env

          # AWS S3
          echo "S3_BUCKET=${{ secrets.S3_BUCKET }}" >> .env
          echo "AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}" >> .env

          # CORS / Frontend
          echo "CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}" >> .env

          # Models
          echo "MODEL_MAIN=${{ secrets.MODEL_MAIN }}" >> .env
          echo "TEMP_MAIN=${{ secrets.TEMP_MAIN }}" >> .env
          echo "MODEL_SUBAGENT=${{ secrets.MODEL_SUBAGENT }}" >> .env
          echo "TEMP_SUBAGENT=${{ secrets.TEMP_SUBAGENT }}" >> .env
          echo "MODEL_SUPERVISOR=${{ secrets.MODEL_SUPERVISOR }}" >> .env
          echo "TEMP_SUPERVISOR=${{ secrets.TEMP_SUPERVISOR }}" >> .env
          echo "MODEL_INTERNAL=${{ secrets.MODEL_INTERNAL }}" >> .env
          echo "TEMP_INTERNAL=${{ secrets.TEMP_INTERNAL }}" >> .env

      - name: "ğŸ“¦ Sync files to EC2"
        run: |
          echo "ğŸ”„ Syncing project files to EC2..."
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ec2:/home/${{ secrets.EC2_USER }}/BookAI

      - name: "ğŸ³ Rebuild & restart Docker containers"
        run: |
          echo "ğŸ”§ Connecting to EC2 to rebuild Docker environment..."
          ssh ec2 '
            set -e
            cd ~/BookAI
            echo "ğŸ§¹ Stopping old containers..."
            docker compose down || true
            echo "ğŸ§± Building Docker images..."
            docker compose build --no-cache
            echo "ğŸš€ Starting services..."
            docker compose up -d
            echo "âœ… Deployment completed successfully!"
          '
