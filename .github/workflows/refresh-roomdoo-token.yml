name: üîÑ Refresh Roomdoo Token

on:
  schedule:
    - cron: "0 9 * * *" # Ejecuta todos los d√≠as a las 09:00 UTC (10:00 CET)
  push:
    branches:
      - mcp_server
  workflow_dispatch: # Permite ejecutarlo manualmente

jobs:
  refresh-token:
    name: Refresh Roomdoo Token in Supabase
    runs-on: ubuntu-latest

    steps:
      - name: üß† Login en Roomdoo y actualizar token
        run: |
          echo "üîê Iniciando login en Roomdoo..."

          # 1Ô∏è‚É£ Login en Roomdoo
          RESPONSE=$(curl -s -X POST "$ROOMDOO_LOGIN_URL" \
            -H "Content-Type: application/json" \
            -d "{\"username\": \"$ROOMDOO_USERNAME\", \"password\": \"$ROOMDOO_PASSWORD\"}")

          TOKEN=$(echo "$RESPONSE" | jq -r '.token')

          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "‚ùå No se recibi√≥ token v√°lido de Roomdoo."
            echo "Respuesta completa: $RESPONSE"
            exit 1
          fi

          echo "‚úÖ Token obtenido correctamente."

          # 2Ô∏è‚É£ Guardar/actualizar token en Supabase (upsert)
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          RESPONSE_SUPABASE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$SUPABASE_URL/rest/v1/tokens_roomdoo" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "{\"token\": \"roomdoo_token\", \"key\": \"$TOKEN\", \"created_at\": \"$NOW\"}")

          if [ "$RESPONSE_SUPABASE" -ge 200 ] && [ "$RESPONSE_SUPABASE" -lt 300 ]; then
            echo "‚úÖ Token actualizado en Supabase (HTTP $RESPONSE_SUPABASE) a las $NOW"
            echo "üü¢ Workflow completado con √©xito."
          else
            echo "‚ùå Error al actualizar token en Supabase. C√≥digo: $RESPONSE_SUPABASE"
            exit 1
          fi

    env:
      ROOMDOO_LOGIN_URL: ${{ secrets.ROOMDOO_LOGIN_URL }}
      ROOMDOO_USERNAME: ${{ secrets.ROOMDOO_USERNAME }}
      ROOMDOO_PASSWORD: ${{ secrets.ROOMDOO_PASSWORD }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
