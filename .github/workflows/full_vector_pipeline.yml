name: "ðŸ”„ Full S3 â†’ Supabase Vectorization"

on:
  workflow_dispatch:             # Lanzar manualmente desde GitHub
    inputs:
      full_refresh:
        description: "Limpiar tablas y revectorizar todo (true/false)"
        required: false
        default: "false"
  push:
    branches:
      - vectorizer-pipeline      # O cuando haya cambios en esta rama
  schedule:
    - cron: "0 3 * * *"          # Ejecutar cada dÃ­a a las 03:00 UTC

permissions:
  id-token: write                # Para autenticaciÃ³n OIDC con AWS
  contents: read

jobs:
  # ðŸ§© 1ï¸âƒ£ Sincroniza S3
  sync-s3:
    name: "ðŸ§© 1ï¸âƒ£ Sync S3"
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ›Žï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ðŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ðŸ” Configure AWS credentials (OIDC)"
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::958933161814:role/github-oidc-s3-access
          aws-region: eu-west-1

      - name: "ðŸŒ Load environment variables"
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "S3_BUCKET=bookai-pre-roomdoo" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=eu-west-1" >> $GITHUB_ENV
          echo "FULL_REFRESH=${{ github.event.inputs.full_refresh }}" >> $GITHUB_ENV

      - name: "ðŸš€ Step 1: Sync with S3"
        run: python -m pipeline.s3_client

  # â³ 2ï¸âƒ£ Validar filtro de fechas (IA)
  deadline-filter:
    name: "â³ 2ï¸âƒ£ Deadline Filter"
    needs: [sync-s3]
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ›Žï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ðŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ðŸŒ Load environment variables"
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=eu-west-1" >> $GITHUB_ENV

      - name: "ðŸš§ Step 2: Dry-run deadline filter check"
        run: |
          python - <<'PY'
          from pipeline.deadline_filter import filter_expired_sections, is_variable_doc

          sample = "Durante los dÃ­as 23 y 24 de diciembre se ofrecerÃ¡n turrones."
          cleaned, removed = filter_expired_sections(sample)
          print("is_variable_doc('Alda Hotels Centro Ponferrada-Variable.docx') ->", is_variable_doc("Alda Hotels Centro Ponferrada-Variable.docx"))
          print("Removed blocks:", removed)
          print("Filtered text:", cleaned)
          PY

  # ðŸ§  3ï¸âƒ£ Vectoriza en Supabase (depende del anterior)
  vectorize:
    name: "ðŸ§  3ï¸âƒ£ Vectorize in Supabase"
    needs: [deadline-filter]
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ›Žï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ðŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ðŸ” Configure AWS credentials (OIDC)"
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::958933161814:role/github-oidc-s3-access
          aws-region: eu-west-1

      - name: "ðŸŒ Load environment variables"
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "S3_BUCKET=bookai-pre-roomdoo" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=eu-west-1" >> $GITHUB_ENV
          echo "FULL_REFRESH=${{ github.event.inputs.full_refresh }}" >> $GITHUB_ENV

      - name: "ðŸš€ Step 3: Run full vectorization pipeline"
        run: python -m pipeline.run_pipeline

  # ðŸ§¹ 4ï¸âƒ£ Limpia cache temporal (depende del anterior)
  clear-daily-cache:
    name: "ðŸ§¹ 4ï¸âƒ£ Clear kb_daily_cache"
    needs: [vectorize]
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ›Žï¸ Checkout repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: "ðŸ“¦ Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "ðŸŒ Load environment variables"
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> $GITHUB_ENV
          echo "TEMP_KB_TABLE=kb_daily_cache" >> $GITHUB_ENV

      - name: "ðŸ§¹ Step 4: Clear kb_daily_cache"
        run: |
          python - <<'PY'
          import os
          from supabase import create_client

          url = os.getenv("SUPABASE_URL")
          key = os.getenv("SUPABASE_KEY")
          table = os.getenv("TEMP_KB_TABLE", "kb_daily_cache")
          if not url or not key:
              raise SystemExit("Missing SUPABASE_URL or SUPABASE_KEY")

          supabase = create_client(url, key)
          supabase.table(table).delete().not_.is_("id", "null").execute()
          print(f"Cleared {table}")
          PY
